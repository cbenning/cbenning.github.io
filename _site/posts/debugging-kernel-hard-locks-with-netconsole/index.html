<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Debugging Kernel hard locks with netconsole</title>

  <meta name="author" content="Chris Benninger" />
  <meta name="description" content="Code, rants, utilities, tutorials, projects and other things by Chris Benninger." />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="alternate" type="application/rss+xml" href="/atom.xml" />

  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300'
    rel='stylesheet' type='text/css'>

  <link href="/css/up.css" rel="stylesheet">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="apple-touch-icon-144x144-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="apple-touch-icon-114x114-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="apple-touch-icon-72x72-precomposed.png">
  <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-57x57-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

</head>

<body>
  <div class="navbar navbar-fixed-top">
    <div class="container">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Chris Benninger</a>
      <div class="nav-collapse collapse navbar-responsive-collapse">
        <ul class="nav navbar-nav pull-right hidden-print">
          <li>
            <a class="hidden-sm" href="http://github.com/caarlos0/up"
              title="Get this theme!">
              <i class="icon-download icon-large"></i>
            </a>
            <a class="visible-sm" href="http://github.com/caarlos0/up"
              title="Get this theme!">
              <i class="icon-download icon-large"></i>
              Get this theme!
            </a>
          </li>
          <li>
            <a class="hidden-sm" title="About me" href="/about.html">
              <i class="icon-user icon-large"></i>
            </a>
            <a class="visible-sm" title="About me" href="/about.html">
              <i class="icon-user icon-large"></i>
              About me
            </a>
          </li>
          <li>
            <a class="hidden-sm" href="/atom.xml" title="Atom Feed">
              <i class="icon-rss icon-large"></i>
            </a>
            <a class="visible-sm" href="/atom.xml" title="Atom Feed">
              <i class="icon-rss icon-large"></i>
              Atom Feed
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="container">
    <section class="content">
  <h1>
    <a href="/posts/debugging-kernel-hard-locks-with-netconsole">Debugging Kernel hard locks with netconsole</a>
  </h1>

  <section class="byline">
    January  5, 2011
  </section>

  There is already plenty of literature in this subject, I just thought I would throw in my vote.

Currently I am building a pair of kernel tools. As i have learned, debugging more complex kernel modules could be considered an art of it's own. A rather large and fuzzy section of my code is causing a hard lock of my entire test system. Unfortunately because this is a hard lock (entire kernel is in an corrupted and unrecoverable state) none of my debugging output makes it to the daemons responsible for displaying them before the entire system grinds to a screeching halt.
<!--more-->
After some googling I came to the conclusion that I needed an external logging mechanism, a highly-recommended one being to use a null-modem serial cable and tell the test kernel to output all messages to the serial port as well. Long story short, after a trip to The Source, about 4 hours of troubleshooting and $30 later my dev machine was inexplicably still not outputting system logs.

Shortly before giving up for the day, I found several articles about a kernel module called "netconsole". This module basically works very low in the network card driver stack to spew kernel message out onto the network via UDP. After less than 30 minutes I had this tool working beautifully and identified the line of code causing the lockup.

There are several tutorials on how to use this so I wont get too into it, but essentially I only had to do three simple steps.
<h1>Simple Procedure (Debian)</h1>
1. Set the options for the module (port/ip/ etc. we want to send messages to/from on the network) on my test machine. I did this by adding a file in /etc/modules.d called netconsole.conf which looked something like this (I run Debian testing by the way):
<pre>options netconsole netconsole=&lt;from_port&gt;@&lt;from_ip/&lt;out_eth_port&gt;,&lt;to_port&gt;@&lt;to_ip&gt;/&lt;to_mac_addr&gt;</pre>
2. Load the module, you may also want to set the module to load on start if you have not already.
<pre>&gt; modprobe netconsole</pre>
3. Log data from remote computer. On the machine with the IP/mac you specified as the "to" location, use netcat to dump out what you get on that port:
<pre>&gt; nc -l -u -p &lt;to_port&gt;</pre>
At this point you should be getting kernel messages from the other machine!
<h1>Firewall</h1>
If you aren't getting any messages, make sure your firewall isn't blocking the port you are using to send the logs.
<h1>Conclusion</h1>
In conclusion, netconsole is very effective at what it does, is simpler and cheaper to setup than using a serial console. The only downside I can see is if you are trying to debug a network card driver. All-in-all, super useful.
<h1>References</h1>
<ul>
	<li><a href="http://www.cyberciti.biz/tips/linux-netconsole-log-management-tutorial.html">Linux Configure Netconsole To Log Messages Over UDP Network</a></li>
	<li><a href="http://www.novell.com/communities/node/4753/netconsole-howto-send-kernel-boot-messages-over-ethernet">Netconsole howto: send kernel boot messages over ethernet</a></li>
	<li><a href="http://www.novell.com/communities/node/4753/netconsole-howto-send-kernel-boot-messages-over-ethernet"></a><a href="http://mindplusplus.wordpress.com/2010/03/06/using-netconsole-on-linux/">Using Netconsole on Linux</a></li>
</ul>

  <div class="pull"></div>
  <a  href="https://twitter.com/share" class="twitter-share-button"
data-via="chrisbenninger" data-lang="en" data-size="large">Tweet</a>
<script>
!function(d,s,id){
  var js,fjs=d.getElementsByTagName(s)[0];
  if(!d.getElementById(id)){
    js=d.createElement(s);
    js.id=id;
    js.src="//platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js,fjs);
  }
}(document,"script","twitter-wjs");
</script>

  <hr>
  <div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'benningerca';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</section>

  </div>

  <div id="footer" class="hidden-print">
    <section class="meta">
      <div class="container">
        <div class="row">
          <div class="col col-lg-2 col-offset-4">
            <a href="https://twitter.com/chrisbenninger">
              <i class="icon icon-twitter icon-4x"></i>
              <div>Follow me on Twitter.</div>
            </a>
          </div>
          <div class="col col-lg-2 next">
            <a href="https://github.com/chrisbenninger">
              <i class="icon icon-github icon-4x"></i>
              <div>
                See my github profile.
              </div>
            </a>
          </div>
        </div>
      </div>
    </section>
  </div>
  
<script type="text/javascript">

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-5453717-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

</script>


  

</body>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="/js/up.js"></script>
</html>
