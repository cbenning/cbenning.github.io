<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Adding support for an unsupported power controller in Emulab</title>

  <meta name="author" content="Chris Benninger" />
  <meta name="description" content="Code, rants, utilities, tutorials, projects and other things by Chris Benninger." />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="alternate" type="application/rss+xml" href="/atom.xml" />

  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300'
    rel='stylesheet' type='text/css'>

  <link href="/css/up.css" rel="stylesheet">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="apple-touch-icon-144x144-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="apple-touch-icon-114x114-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="apple-touch-icon-72x72-precomposed.png">
  <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-57x57-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

</head>

<body>
  <div class="navbar navbar-fixed-top">
    <div class="container">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Chris Benninger</a>
      <div class="nav-collapse collapse navbar-responsive-collapse">
        <ul class="nav navbar-nav pull-right hidden-print">
          <li>
            <a class="hidden-sm" href="http://github.com/caarlos0/up"
              title="Get this theme!">
              <i class="icon-download icon-large"></i>
            </a>
            <a class="visible-sm" href="http://github.com/caarlos0/up"
              title="Get this theme!">
              <i class="icon-download icon-large"></i>
              Get this theme!
            </a>
          </li>
          <li>
            <a class="hidden-sm" title="About me" href="/about.html">
              <i class="icon-user icon-large"></i>
            </a>
            <a class="visible-sm" title="About me" href="/about.html">
              <i class="icon-user icon-large"></i>
              About me
            </a>
          </li>
          <li>
            <a class="hidden-sm" href="/atom.xml" title="Atom Feed">
              <i class="icon-rss icon-large"></i>
            </a>
            <a class="visible-sm" href="/atom.xml" title="Atom Feed">
              <i class="icon-rss icon-large"></i>
              Atom Feed
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="container">
    <section class="content">
  <h1>
    <a href="/posts/adding-support-for-an-unsupported-power-manager-in-emulab">Adding support for an unsupported power controller in Emulab</a>
  </h1>

  <section class="byline">
    November  7, 2010
  </section>

  As a continuation of sorts to my <a href="http://www.penninger.ca/?p=38">previous post</a>, I thought I would also do a short description of adding support for an unsupported power controller. The IBM Bladecenter is more or less unsupported by Emulab in all respects, the switches and the integrated power controller are unsupported and even the blade servers grudgingly resist running any vanilla FreeBSD images that come with the Emulab source.

Note: <em>This set of steps is very similar to my post about <a href="http://www.benninger.ca/?p=38">adding switch support</a></em>
<!--more-->
<em>
</em>
<h1>Create a new case</h1>
Add a case to /usr/testbed/bin/power to include a new power type, I'll use "mynewpower" in this example. Edit this file and include the perl module you will be putting your code in by adding this to the top:
<pre class="brush: perl">use power_mynewpower;   ##Assuming your module is called power_mynewpower.pm</pre>
<em>
</em>
Somewhere around line 332 you'll find the beginning of the IF you'll need to add your case to:
<pre class="brush: perl">#
# Finally, we look at the controller type and construct the proper type
# of object
#
my $errors = 0;
if ($type eq "APC") {
my $device = new snmpit_apc($IP,$verbose);
if (!defined $device) {
    warn "Unable to contact controller for $nodestr. Skipping...\n";
    next;
} else {
    print "Calling device-&gt;power($op,@outlets)\n"
	if $verbose &gt; 1;
    if ($device-&gt;power($op,@outlets)) {
	print "Control of $nodestr failed.\n";
	$errors++;
    }
}
} elsif ($type =~ "RPC") {
if (rpc27ctrl($op,$power_id,@outlets)) {
    print "Control of $nodestr failed.\n"; $exitval++;
}
} elsif (($class eq "sg") || ($type eq "garcia")) {
# XXX: 'garcia' is temporary until stargates are subnodes of
# garcias
if (sgmotectrl($op,@nodes)) {
    print "Control of $nodestr failed.\n"; $exitval++;
    $errors++;
}
} elsif ($type =~ /whol-(\w+)/) {
my $iface = $1;
if (wholctrl($op,$iface,@nodes)) {
    print "Control of $nodestr failed.\n"; $exitval++;
    $errors++;
}
} elsif ($type =~ /rmcp-(\w+)/) {
if (rmcpctrl($1,$op,@nodes)) {
    print "Control of $nodestr failed.\n"; ++$exitval;
    ++$errors;
}
} elsif ($type eq 'ilo2' || $type eq 'ilo') {
if (iloctrl($type,$op,@nodes)) {
    print "Control of $nodestr failed.\n"; ++$exitval;
        ++$errors;
    }
} elsif ($type eq "mail") {
if (mailctrl($op,@nodes)) {
    print "Control of $nodestr failed.\n"; $exitval++;
    $errors++;
}
$sendevent = 0; # power_mail sends this itself.
#------------------------------------------------------------------------
# This calls mynewpower_nodectrl() inside power_mynewpower.pm when
# it encounters our new power type
#------------------------------------------------------------------------
} elsif ($type eq "mynewpower") {
   if (mynewpower_nodectrl($1,$op,@nodes)) {
	print "Control of $nodestr failed.\n"; $exitval++;
	$errors++;
   }
}
#------------------------------------------------------------------------
else {
print "power: Unknown power type '$type'\n";
$errors++;
}</pre>
<h1><em>
</em>
Implement the code</h1>
Now just create a perl package <em>power_mynewpower.pm</em> and implement the <em>mynewpower_nodectrl($type,$cmd,@nodes)</em> subroutine.  As far as I can tell, the $cmd value that is most important for experimental nodes is the "cycle" command. Here is a sample file:
<pre class="brush: perl">#!/usr/bin/perl -wT
#

package power_mynewpower;

use Exporter;
@ISA = ("Exporter");
@EXPORT = qw( mynewpower_nodectrl );

use lib "/usr/testbed/lib";
use libdb;

sub mynewpower_nodectrl($$@) {
    my ($type,$cmd,@nodes) = @_;
    my $exitval = 0;
    print "mynewpower_nodectrl called with $type,$cmd,(" . join(',',@nodes) . ")\n";

    if($cmd eq "cycle"){
        ##Do something here
    }
    return $exitval;	
}</pre>
In our case, this routine executes a bash script which logs in and reboots the specified node from the bladecenter.

<em>
</em>
<h1>Add the type to the database</h1>
Add a new row into the 'node_types' table:
<table>
<tbody>
<tr>
<th>class</th>
<th>type</th>
</tr>
<tr>
<td>power</td>
<td>mynewpower</td>
</tr>
</tbody>
</table>
Now just follow the <a href="https://wiki.emulab.net/wiki/install/power-control.html">instructions on the Emulab Wiki</a> for adding nodes that use the power type. Emulab will automatically find your implemented perl module and run the specified subroutine when it attempts to perform a power operation on a node which has a "mynewpower" power manager. You should be good to go! Feedback is very welcome.

  <div class="pull"></div>
  <a  href="https://twitter.com/share" class="twitter-share-button"
data-via="chrisbenninger" data-lang="en" data-size="large">Tweet</a>
<script>
!function(d,s,id){
  var js,fjs=d.getElementsByTagName(s)[0];
  if(!d.getElementById(id)){
    js=d.createElement(s);
    js.id=id;
    js.src="//platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js,fjs);
  }
}(document,"script","twitter-wjs");
</script>

  <hr>
  <div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'benningerca';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</section>

  </div>

  <div id="footer" class="hidden-print">
    <section class="meta">
      <div class="container">
        <div class="row">
          <div class="col col-lg-2 col-offset-4">
            <a href="https://twitter.com/chrisbenninger">
              <i class="icon icon-twitter icon-4x"></i>
              <div>Follow me on Twitter.</div>
            </a>
          </div>
          <div class="col col-lg-2 next">
            <a href="https://github.com/chrisbenninger">
              <i class="icon icon-github icon-4x"></i>
              <div>
                See my github profile.
              </div>
            </a>
          </div>
        </div>
      </div>
    </section>
  </div>
  
<script type="text/javascript">

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-5453717-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

</script>


  

</body>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="/js/up.js"></script>
</html>
